<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organize PDF â€” PDF for Humans</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .drag-over-item {
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .page-card:hover .page-overlay {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-[#0f172a] text-slate-200 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const { PDFDocument, degrees } = PDFLib;

        const Icons = {
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></svg>,
            RotateCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>
        };

        const App = () => {
            const [file, setFile] = React.useState(null);
            const [pdfDoc, setPdfDoc] = React.useState(null);
            const [pages, setPages] = React.useState([]); // Array of { id, originalIndex, rotation, uniqueId }
            const [thumbnails, setThumbnails] = React.useState({});
            const [draggedItem, setDraggedItem] = React.useState(null);
            const [isSaving, setIsSaving] = React.useState(false);
            const fileInputRef = React.useRef(null);

            const handleFileChange = async (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                setFile(selectedFile);

                try {
                    const arrayBuffer = await selectedFile.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    setPdfDoc(pdf);

                    const newPages = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                        newPages.push({
                            id: i,
                            originalIndex: i - 1,
                            rotation: 0,
                            uniqueId: Math.random().toString(36).substr(2, 9)
                        });

                        // Generate thumbnail lazily
                        generateThumbnail(pdf, i);
                    }
                    setPages(newPages);
                } catch (err) {
                    console.error("Error loading PDF", err);
                    alert("Error loading PDF");
                }
            };

            const generateThumbnail = async (pdf, pageNum) => {
                try {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 0.3 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport }).promise;
                    setThumbnails(prev => ({
                        ...prev,
                        [pageNum]: canvas.toDataURL()
                    }));
                } catch (err) {
                    console.error("Thumbnail error", err);
                }
            };

            const handleRotate = (uniqueId) => {
                setPages(prev => prev.map(p =>
                    p.uniqueId === uniqueId ? { ...p, rotation: (p.rotation + 90) % 360 } : p
                ));
            };

            const handleDelete = (uniqueId) => {
                setPages(prev => prev.filter(p => p.uniqueId !== uniqueId));
            };

            // Drag and Drop
            const handleDragStart = (e, index) => {
                setDraggedItem(index);
                e.dataTransfer.effectAllowed = "move";
                // Invisible ghost image if wanted, or default
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedItem === null || draggedItem === index) return;

                const newPages = [...pages];
                const item = newPages[draggedItem];
                newPages.splice(draggedItem, 1);
                newPages.splice(index, 0, item);

                setPages(newPages);
                setDraggedItem(index);
            };

            const handleSave = async () => {
                if (!file || pages.length === 0) return;
                setIsSaving(true);

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const originalPdf = await PDFDocument.load(arrayBuffer);
                    const newPdf = await PDFDocument.create();

                    // Copy pages in current order
                    // We need to map original indices
                    const pageIndices = pages.map(p => p.originalIndex);
                    const copiedPages = await newPdf.copyPages(originalPdf, pageIndices);

                    pages.forEach((p, i) => {
                        const newPage = copiedPages[i];
                        // Apply accumulated rotation
                        const currentRotation = newPage.getRotation().angle;
                        newPage.setRotation(degrees(currentRotation + p.rotation));
                        newPdf.addPage(newPage);
                    });

                    const pdfBytes = await newPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    window.saveAs(blob, file.name.replace('.pdf', '_organized.pdf'));

                } catch (err) {
                    console.error("Save error", err);
                    alert("Failed to save PDF");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="flex flex-col min-h-screen">
                    {/* Header */}
                    <div className="h-16 bg-[#1e293b] border-b border-gray-700 flex items-center px-6 justify-between shrink-0 sticky top-0 z-20">
                        <div className="flex items-center gap-4">
                            <a href="../index.html" className="text-slate-400 hover:text-white transition-colors">
                                <Icons.ArrowLeft />
                            </a>
                            <h1 className="font-semibold text-lg text-white">Organize PDF</h1>
                        </div>

                        {file && (
                            <button
                                onClick={handleSave}
                                disabled={isSaving}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg font-medium transition-colors shadow-lg shadow-blue-500/20 disabled:opacity-50"
                            >
                                {isSaving ? 'Saving...' : (
                                    <>
                                        <Icons.Download />
                                        Save Changes
                                    </>
                                )}
                            </button>
                        )}
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-8 bg-[#0f172a]">
                        {!file ? (
                            <div className="max-w-xl mx-auto mt-20 text-center">
                                <div
                                    onClick={() => fileInputRef.current?.click()}
                                    className="border-2 border-dashed border-slate-700 bg-slate-800/50 rounded-2xl p-12 cursor-pointer hover:border-blue-500 hover:bg-slate-800 transition-all group"
                                >
                                    <div className="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors text-slate-400">
                                        <Icons.Upload />
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-3">Upload PDF to Organize</h2>
                                    <p className="text-slate-400">Rearrange, rotate, or remove pages from your document.</p>
                                </div>
                            </div>
                        ) : (
                            <div className="max-w-6xl mx-auto">
                                <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-6">
                                    {pages.map((page, index) => (
                                        <div
                                            key={page.uniqueId}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, index)}
                                            onDragOver={(e) => handleDragOver(e, index)}
                                            className="relative group bg-white rounded shadow-lg transition-transform hover:-translate-y-1 page-card cursor-move"
                                            style={{
                                                opacity: draggedItem === index ? 0.3 : 1
                                            }}
                                        >
                                            {/* Page Number Badge */}
                                            <div className="absolute top-2 left-2 bg-slate-900/80 text-white text-xs px-2 py-1 rounded z-10">
                                                Page {index + 1}
                                            </div>

                                            {/* Thumbnail */}
                                            <div className="aspect-[1/1.4] bg-slate-200 overflow-hidden rounded relative">
                                                {thumbnails[page.id] ? (
                                                    <img
                                                        src={thumbnails[page.id]}
                                                        className="w-full h-full object-contain transition-transform"
                                                        style={{ transform: `rotate(${page.rotation}deg)` }}
                                                        alt={`Page ${page.id}`}
                                                    />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-slate-400">
                                                        Loading...
                                                    </div>
                                                )}
                                            </div>

                                            {/* Hover Overlay Controls */}
                                            <div className="absolute inset-0 bg-slate-900/60 opacity-0 transition-opacity flex items-center justify-center gap-2 page-overlay rounded">
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); handleRotate(page.uniqueId); }}
                                                    className="p-2 bg-white text-slate-900 rounded-full hover:bg-blue-50 transition-colors"
                                                    title="Rotate"
                                                >
                                                    <Icons.RotateCw />
                                                </button>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); handleDelete(page.uniqueId); }}
                                                    className="p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                                                    title="Delete Page"
                                                >
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleFileChange}
                        accept="application/pdf"
                        className="hidden"
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>