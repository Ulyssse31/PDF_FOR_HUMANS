<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Highlighter ‚Äî PDF for Humans</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-teal-900 to-slate-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const { useState, useRef, useEffect } = React;

        // Academic term patterns with colors
        const academicTerms = [
            {
                name: 'Definition',
                color: '#3b82f6', // blue
                bgColor: 'rgba(59, 130, 246, 0.15)',
                patterns: [
                    /^(Definition|D√©finition)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i,
                    /^(Def\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Theorem',
                color: '#22c55e', // green
                bgColor: 'rgba(34, 197, 94, 0.15)',
                patterns: [
                    /^(Theorem|Th√©or√®me)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i,
                    /^(Thm\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Lemma',
                color: '#eab308', // yellow
                bgColor: 'rgba(234, 179, 8, 0.15)',
                patterns: [
                    /^(Lemma|Lemme)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i,
                    /^(Lem\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Proposition',
                color: '#f97316', // orange
                bgColor: 'rgba(249, 115, 22, 0.15)',
                patterns: [
                    /^(Proposition|Prop\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i
                ]
            },
            {
                name: 'Proof',
                color: '#a855f7', // purple
                bgColor: 'rgba(168, 85, 247, 0.15)',
                patterns: [
                    /^(Proof|Preuve|D√©monstration)\s*[:\.\-‚Äì‚Äî]?/i,
                    /^(Pf\.?)\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Example',
                color: '#ec4899', // pink
                bgColor: 'rgba(236, 72, 153, 0.15)',
                patterns: [
                    /^(Example|Exemple)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i,
                    /^(Ex\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Corollary',
                color: '#06b6d4', // cyan
                bgColor: 'rgba(6, 182, 212, 0.15)',
                patterns: [
                    /^(Corollary|Corollaire)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i,
                    /^(Cor\.?)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]/i
                ]
            },
            {
                name: 'Remark',
                color: '#64748b', // slate
                bgColor: 'rgba(100, 116, 139, 0.15)',
                patterns: [
                    /^(Remark|Remarque|Note)\s*[\d.]*\s*[:\.\-‚Äì‚Äî]?/i
                ]
            }
        ];

        const App = () => {
            const [file, setFile] = useState(null);
            const [pdfDoc, setPdfDoc] = useState(null);
            const [numPages, setNumPages] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [detectedTerms, setDetectedTerms] = useState([]);
            const [enabledTerms, setEnabledTerms] = useState(academicTerms.map(t => t.name));
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState(0);
            const [highlightMode, setHighlightMode] = useState('auto'); // auto or underline
            const canvasRef = useRef(null);
            const [pageTextItems, setPageTextItems] = useState([]);

            const handleFile = async (f) => {
                if (!f || f.type !== 'application/pdf') return;

                setFile(f);
                setStatus('loading');

                try {
                    const arrayBuffer = await f.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    setPdfDoc(pdf);
                    setNumPages(pdf.numPages);
                    setCurrentPage(1);

                    // Scan entire document for academic terms
                    await scanDocument(pdf);

                    setStatus('idle');
                } catch (err) {
                    console.error(err);
                    setStatus('error');
                }
            };

            const scanDocument = async (pdf) => {
                const found = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();

                    textContent.items.forEach(item => {
                        const text = item.str.trim();
                        if (!text) return;

                        academicTerms.forEach(term => {
                            term.patterns.forEach(pattern => {
                                if (pattern.test(text)) {
                                    found.push({
                                        page: i,
                                        text: text.substring(0, 50) + (text.length > 50 ? '...' : ''),
                                        type: term.name,
                                        color: term.color
                                    });
                                }
                            });
                        });
                    });
                }

                setDetectedTerms(found);
            };

            const renderPreview = async () => {
                if (!pdfDoc || !canvasRef.current) return;

                const page = await pdfDoc.getPage(currentPage);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');

                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Render page
                await page.render({ canvasContext: ctx, viewport }).promise;

                // Get text positions
                const textContent = await page.getTextContent();
                const items = textContent.items;
                setPageTextItems(items);

                // Highlight detected terms
                items.forEach(item => {
                    const text = item.str.trim();
                    if (!text) return;

                    academicTerms.forEach(term => {
                        if (!enabledTerms.includes(term.name)) return;

                        term.patterns.forEach(pattern => {
                            if (pattern.test(text)) {
                                const tx = item.transform;
                                const x = tx[4] * scale;
                                const y = canvas.height - (tx[5] * scale);
                                const width = item.width * scale;
                                const height = item.height * scale || 14 * scale;

                                if (highlightMode === 'auto') {
                                    ctx.fillStyle = term.bgColor;
                                    ctx.fillRect(x, y - height, width + 10, height + 4);

                                    // Left border
                                    ctx.fillStyle = term.color;
                                    ctx.fillRect(x - 3, y - height, 3, height + 4);
                                } else {
                                    ctx.strokeStyle = term.color;
                                    ctx.lineWidth = 2;
                                    ctx.beginPath();
                                    ctx.moveTo(x, y);
                                    ctx.lineTo(x + width + 10, y);
                                    ctx.stroke();
                                }
                            }
                        });
                    });
                });
            };

            useEffect(() => {
                renderPreview();
            }, [pdfDoc, currentPage, enabledTerms, highlightMode]);

            const toggleTerm = (termName) => {
                setEnabledTerms(prev =>
                    prev.includes(termName)
                        ? prev.filter(t => t !== termName)
                        : [...prev, termName]
                );
            };

            const applyHighlights = async () => {
                if (!pdfDoc) return;

                setStatus('processing');
                setProgress(0);

                try {
                    const { jsPDF } = window.jspdf;

                    const firstPage = await pdfDoc.getPage(1);
                    const viewport = firstPage.getViewport({ scale: 2 });

                    const pdf = new jsPDF({
                        orientation: viewport.width > viewport.height ? 'landscape' : 'portrait',
                        unit: 'pt',
                        format: [viewport.width / 2, viewport.height / 2]
                    });

                    for (let i = 1; i <= numPages; i++) {
                        setProgress(Math.round((i / numPages) * 100));

                        const page = await pdfDoc.getPage(i);
                        const vp = page.getViewport({ scale: 2 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = vp.width;
                        canvas.height = vp.height;

                        await page.render({ canvasContext: ctx, viewport: vp }).promise;

                        // Get text and highlight
                        const textContent = await page.getTextContent();
                        textContent.items.forEach(item => {
                            const text = item.str.trim();
                            if (!text) return;

                            academicTerms.forEach(term => {
                                if (!enabledTerms.includes(term.name)) return;

                                term.patterns.forEach(pattern => {
                                    if (pattern.test(text)) {
                                        const tx = item.transform;
                                        const scale = 2;
                                        const x = tx[4] * scale;
                                        const y = canvas.height - (tx[5] * scale);
                                        const width = item.width * scale;
                                        const height = item.height * scale || 14 * scale;

                                        if (highlightMode === 'auto') {
                                            ctx.fillStyle = term.bgColor;
                                            ctx.fillRect(x, y - height, width + 10, height + 4);
                                            ctx.fillStyle = term.color;
                                            ctx.fillRect(x - 3, y - height, 3, height + 4);
                                        } else {
                                            ctx.strokeStyle = term.color;
                                            ctx.lineWidth = 3;
                                            ctx.beginPath();
                                            ctx.moveTo(x, y + 2);
                                            ctx.lineTo(x + width + 10, y + 2);
                                            ctx.stroke();
                                        }
                                    }
                                });
                            });
                        });

                        if (i > 1) {
                            pdf.addPage([vp.width / 2, vp.height / 2], vp.width > vp.height ? 'landscape' : 'portrait');
                        }

                        const imgData = canvas.toDataURL('image/jpeg', 0.92);
                        pdf.addImage(imgData, 'JPEG', 0, 0, vp.width / 2, vp.height / 2);
                    }

                    const blob = pdf.output('blob');
                    const name = file.name.replace('.pdf', '_highlighted.pdf');
                    window.saveAs(blob, name);

                    setStatus('success');
                    setTimeout(() => setStatus('idle'), 3000);
                } catch (err) {
                    console.error(err);
                    setStatus('error');
                }
            };

            const termCounts = academicTerms.map(term => ({
                ...term,
                count: detectedTerms.filter(d => d.type === term.name).length
            }));

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-6xl mx-auto">
                        <a href="../index.html" className="inline-flex items-center gap-2 text-teal-300 hover:text-white mb-4 transition-colors">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back to Tools
                        </a>
                        <h1 className="text-3xl font-bold text-white mb-2">Academic Highlighter</h1>
                        <p className="text-slate-400 mb-8">Auto-detect and color-code definitions, theorems, lemmas, and proofs in textbooks.</p>

                        {!file ? (
                            <div
                                onDrop={(e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); }}
                                onDragOver={(e) => e.preventDefault()}
                                onClick={() => document.getElementById('file-input').click()}
                                className="border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center transition-all hover:border-teal-500 cursor-pointer bg-slate-800/50 backdrop-blur"
                            >
                                <div className="text-6xl mb-4">üìö</div>
                                <p className="text-white font-medium mb-2">Drop your textbook PDF here</p>
                                <p className="text-slate-400 text-sm">Supports mathematical and academic PDFs</p>
                                <input id="file-input" type="file" accept="application/pdf" className="hidden" onChange={(e) => handleFile(e.target.files[0])} />
                            </div>
                        ) : (
                            <div className="grid lg:grid-cols-3 gap-6">
                                {/* Left: Preview */}
                                <div className="lg:col-span-2 bg-slate-800/80 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <p className="text-white font-medium truncate">{file.name}</p>
                                            <p className="text-slate-400 text-sm">Page {currentPage} of {numPages}</p>
                                        </div>
                                        <button onClick={() => { setFile(null); setPdfDoc(null); setDetectedTerms([]); }} className="text-slate-400 hover:text-white text-sm">Change</button>
                                    </div>

                                    {status === 'loading' ? (
                                        <div className="flex flex-col items-center justify-center py-20">
                                            <div className="w-8 h-8 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                            <p className="text-slate-400">Scanning document for academic terms...</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex justify-center mb-4 bg-slate-900 rounded-lg p-4 max-h-[500px] overflow-auto">
                                                <canvas ref={canvasRef} className="max-w-full h-auto rounded shadow-lg" />
                                            </div>

                                            <div className="flex justify-center gap-2">
                                                <button onClick={() => setCurrentPage(Math.max(1, currentPage - 1))} disabled={currentPage === 1} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 text-white rounded-lg">‚Üê</button>
                                                <span className="px-4 py-2 text-slate-300">{currentPage} / {numPages}</span>
                                                <button onClick={() => setCurrentPage(Math.min(numPages, currentPage + 1))} disabled={currentPage === numPages} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 text-white rounded-lg">‚Üí</button>
                                            </div>
                                        </>
                                    )}
                                </div>

                                {/* Right: Controls */}
                                <div className="space-y-4">
                                    {/* Detected Terms Summary */}
                                    <div className="bg-slate-800/80 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                        <h2 className="text-white font-semibold mb-3">Detected Terms</h2>
                                        <p className="text-slate-400 text-sm mb-3">Found {detectedTerms.length} academic terms</p>

                                        <div className="space-y-2">
                                            {termCounts.map(term => (
                                                <button
                                                    key={term.name}
                                                    onClick={() => toggleTerm(term.name)}
                                                    className={`w-full flex items-center justify-between p-2 rounded-lg transition-all ${enabledTerms.includes(term.name) ? 'bg-slate-700' : 'bg-slate-800 opacity-50'
                                                        }`}
                                                >
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-3 h-3 rounded" style={{ backgroundColor: term.color }}></div>
                                                        <span className="text-white text-sm">{term.name}</span>
                                                    </div>
                                                    <span className="text-slate-400 text-sm">{term.count}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Highlight Style */}
                                    <div className="bg-slate-800/80 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                        <h2 className="text-white font-semibold mb-3">Highlight Style</h2>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button
                                                onClick={() => setHighlightMode('auto')}
                                                className={`p-3 rounded-lg border-2 transition-all ${highlightMode === 'auto' ? 'border-teal-500 bg-teal-500/10' : 'border-slate-600'}`}
                                            >
                                                <div className="text-white text-sm">Background</div>
                                            </button>
                                            <button
                                                onClick={() => setHighlightMode('underline')}
                                                className={`p-3 rounded-lg border-2 transition-all ${highlightMode === 'underline' ? 'border-teal-500 bg-teal-500/10' : 'border-slate-600'}`}
                                            >
                                                <div className="text-white text-sm">Underline</div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Progress */}
                                    {status === 'processing' && (
                                        <div className="bg-slate-800/80 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                            <div className="flex justify-between text-sm text-slate-300 mb-2">
                                                <span>Processing...</span>
                                                <span>{progress}%</span>
                                            </div>
                                            <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                <div className="h-full bg-gradient-to-r from-teal-500 to-emerald-500 transition-all" style={{ width: `${progress}%` }}></div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Apply Button */}
                                    <button
                                        onClick={applyHighlights}
                                        disabled={status === 'processing' || detectedTerms.length === 0}
                                        className="w-full py-4 bg-gradient-to-r from-teal-600 to-emerald-600 hover:from-teal-500 hover:to-emerald-500 text-white font-semibold rounded-xl shadow-lg shadow-teal-500/25 transition-all disabled:opacity-50"
                                    >
                                        {status === 'processing' ? 'Processing...' : status === 'success' ? '‚úì Download Started' : 'Apply Highlights & Download'}
                                    </button>

                                    {/* Legend */}
                                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                        <h3 className="text-slate-400 text-xs uppercase tracking-wide mb-2">Color Legend</h3>
                                        <div className="grid grid-cols-2 gap-1 text-xs">
                                            {academicTerms.slice(0, 6).map(term => (
                                                <div key={term.name} className="flex items-center gap-1">
                                                    <div className="w-2 h-2 rounded" style={{ backgroundColor: term.color }}></div>
                                                    <span className="text-slate-400">{term.name}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>